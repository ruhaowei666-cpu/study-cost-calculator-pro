# 📐 软件设计说明

## 整体架构设计

### 1. 模块化设计

```
app.py (UI层)
    ↓ 调用
calculator.py (业务逻辑层)
    ↓ 调用
pdf_generator.py (报告生成层)
```

**设计理由**：
- **分离关注点**：UI、业务逻辑、报告生成各自独立，便于维护和测试
- **可复用性**：calculator.py可以在命令行、Web、API等多种场景下使用
- **易于扩展**：未来可以轻松添加新的输出格式（Excel、CSV等）

### 2. 数据流设计

```
用户输入 → 数据验证 → 计算器初始化 → 现金流计算 → 结果展示
```

**关键设计点**：
- **数据驱动**：城市生活成本数据存储在类常量中，便于更新
- **状态管理**：使用Streamlit的session state管理用户输入（未来可扩展）
- **结果缓存**：计算结果存储在summary字典中，避免重复计算

## 核心计算逻辑设计

### 1. 月收入计算

```python
月收入 = 是否打工 × 每周工作小时 × 4.33周/月 × 平均小时工资
```

**设计考虑**：
- 使用4.33周/月（52周÷12月）更准确地反映月收入
- 平均小时工资设为常量，便于根据地区调整
- 如果未打工，月收入为0

### 2. 月支出计算

```python
月支出 = 房租 + 生活费 + 学费分摊
```

**学费处理逻辑**：
- **一次性支付**：只在9月（第一个月）计入支出
- **分期支付**：分10个月（9月到次年6月）平均分摊

**设计理由**：
- 符合大多数学校的学费支付方式
- 一次性支付会导致9月支出激增，需要足够的初始存款

### 3. 余额计算

```python
累计余额 = 初始存款 + 累计月收入 - 累计月支出
```

**关键点**：
- 使用累计余额而非单月余额，更真实地反映资金状况
- 如果余额为负，表示该月资金不足

### 4. 危险月份识别

```python
危险月份 = 余额 < 0 的所有月份
需要补钱 = abs(最低余额)
```

**设计思路**：
- 不仅找出最低余额的月份，还找出所有负余额月份
- 需要补钱的金额 = 最低余额的绝对值（确保余额回到0以上）

## UI设计思路

### 1. 布局设计

**侧边栏 + 主内容区**：
- **侧边栏**：所有输入表单，集中管理，不占用主内容空间
- **主内容区**：结果展示，包括指标、表格、图表

**设计理由**：
- Streamlit的侧边栏非常适合表单输入
- 主内容区可以展示更多信息，不会被表单占用

### 2. 交互设计

**一键计算模式**：
- 用户填写完所有信息后，点击"开始计算"按钮
- 一次性显示所有结果，无需分步操作

**设计理由**：
- MVP阶段追求简单，避免复杂的多步骤流程
- 所有结果在同一页面展示，便于对比和理解

### 3. 可视化设计

**折线图选择**：
- 使用Plotly而非Matplotlib，因为：
  - 交互性更好（悬停显示数值）
  - 在Streamlit中集成更简单
  - 支持缩放、平移等操作

**零线标注**：
- 在图表中添加y=0的参考线
- 余额在零线以下表示资金不足，一目了然

## 数据设计

### 1. 城市生活成本数据库

```python
CITY_COSTS = {
    "城市": {
        "住宿类型": {
            "房租": 金额,
            "生活费": 金额
        }
    }
}
```

**设计考虑**：
- 使用嵌套字典结构，便于查询和扩展
- 房租和生活费分开，便于单独调整
- 未来可以扩展更多城市和住宿类型

### 2. DataFrame结构

```python
月份 | 月收入（€） | 月支出（€） | 累计余额（€）
```

**设计理由**：
- 使用Pandas DataFrame统一数据结构
- 便于处理和可视化
- 易于导出为Excel/CSV

## PDF报告设计

### 1. 内容结构

1. **用户输入信息**：记录所有输入参数
2. **计算结果摘要**：关键指标汇总
3. **现金流明细表格**：12个月详细数据

**设计理由**：
- 包含完整信息，便于保存和分享
- 结构清晰，易于阅读

### 2. 技术选择

**fpdf2 vs reportlab**：
- **fpdf2**：简单易用，但中文支持有限
- **reportlab**：功能强大，中文支持好，但需要配置字体

**当前实现**：
- 使用fpdf2作为主要方案（简单）
- 提供reportlab的替代实现（可选）

## 错误处理设计

### 1. 输入验证

- Streamlit的number_input自带最小值验证
- selectbox确保只能选择预设选项
- 布尔值使用checkbox，避免无效输入

### 2. 异常处理

```python
try:
    # 计算逻辑
except Exception as e:
    st.error(f"计算出错: {str(e)}")
    st.exception(e)  # 显示详细错误信息
```

**设计理由**：
- 捕获所有异常，避免程序崩溃
- 显示详细错误信息，便于调试

## 扩展性设计

### 1. 数据更新

- 城市生活成本数据存储在类常量中，易于更新
- 未来可以改为从数据库或API读取

### 2. 功能扩展

- **多场景对比**：可以创建多个计算器实例进行对比
- **历史记录**：使用Streamlit的session state保存历史计算
- **数据导入**：可以添加Excel/CSV导入功能

### 3. 部署扩展

- **本地部署**：当前设计支持
- **Streamlit Cloud**：无需修改代码即可部署
- **Docker容器化**：可以添加Dockerfile

## 性能优化考虑

### 1. 计算效率

- 计算逻辑简单，时间复杂度O(1)（固定12个月）
- 无需优化，当前性能已足够

### 2. 内存使用

- 数据量小（12个月数据），内存占用可忽略
- DataFrame操作高效

## 用户体验设计

### 1. 输入简化

- 使用预设选项（城市、住宿类型），减少输入错误
- 提供帮助文本（help参数），指导用户填写

### 2. 输出直观

- **关键指标**：使用metric组件，大字体显示
- **危险提示**：使用warning/success组件，颜色区分
- **可视化**：折线图直观展示趋势

### 3. 反馈及时

- 点击计算后立即显示结果
- 错误信息清晰明确
- 加载状态（Streamlit自动处理）

## 未来迭代方向

### 短期（1-2周）
1. ✅ 核心功能实现
2. ✅ 基础可视化
3. ✅ PDF导出

### 中期（1-2月）
1. 添加更多城市数据
2. 支持自定义生活成本
3. 多场景对比功能
4. 数据导入导出（Excel/CSV）

### 长期（3-6月）
1. 连接实时汇率API
2. 定期更新生活成本数据
3. 多语言支持
4. 移动端适配
5. 用户账户和数据保存

## 总结

本软件采用**简单、清晰、可扩展**的设计原则：

1. **简单**：MVP阶段只实现核心功能，避免过度设计
2. **清晰**：代码结构清晰，注释完整，易于理解
3. **可扩展**：模块化设计，便于未来添加新功能

整个设计以**用户体验**为中心，追求**输入简单、输出直观**的目标。



